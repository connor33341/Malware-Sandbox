#!/bin/bash

# Function to update Wine
update_wine() {
  if command -v apt-get &>/dev/null; then
    sudo apt-get update
    sudo apt-get install -y wine
  elif command -v yum &>/dev/null; then
    sudo yum update -y
    sudo yum install -y wine
  elif command -v brew &>/dev/null; then
    brew update
    brew install wine
  else
    echo "Unsupported package manager. Please install Wine manually."
    exit 1
  fi
}

# Function to create directories with UUID
create_uuid_directories() {
  UUID=$(uuidgen)
  SANDBOX_DIR="sandbox/$UUID"
  OUTPUT_DIR="outputs/$UUID"
  mkdir -p "$SANDBOX_DIR"
  mkdir -p "$OUTPUT_DIR"
  echo "$UUID"
}

# Function to download an EXE from a URL
download_exe() {
  local url=$1
  local dir=$2
  wget -P "$dir" "$url"
}

# Function to start the process using Wine and return XML
start_process_with_wine() {
  local exe_path=$1
  local output_path=$2
  local log_path=$3

  strace -o "$log_path" -f wine "$exe_path" &
  PID=$!

  # Wait a moment to ensure process starts
  sleep 2

  # Gather process data
  PROCESS_NAME=$(ps -p $PID -o comm=)
  CPU_USAGE=$(ps -p $PID -o %cpu=)
  MEM_USAGE=$(ps -p $PID -o %mem=)

  # Generate XML
  XML_OUTPUT=$(xmlstarlet ed -u "/process/pid" -v "$PID" \
                             -u "/process/name" -v "$PROCESS_NAME" \
                             -u "/process/cpu" -v "$CPU_USAGE" \
                             -u "/process/mem" -v "$MEM_USAGE" \
                             -u "/process/status" -v "running" \
                             <(echo '<process><pid/><name/><cpu/><mem/><status/></process>'))

  echo "$XML_OUTPUT" > "$output_path"
}

# Main script execution
if [[ $# -ne 1 ]]; then
  echo "Usage: $0 <exe_url>"
  exit 1
fi

EXE_URL=$1

# Update Wine
update_wine

# Create UUID directories
UUID=$(create_uuid_directories)
SANDBOX_DIR="sandbox/$UUID"
OUTPUT_DIR="outputs/$UUID"
echo "Created directories: $SANDBOX_DIR and $OUTPUT_DIR"

# Download EXE
download_exe "$EXE_URL" "$SANDBOX_DIR"

# Get the downloaded EXE file path
EXE_FILE=$(basename "$EXE_URL")
EXE_PATH="$SANDBOX_DIR/$EXE_FILE"

# Define the output XML and log file paths
OUTPUT_XML_PATH="$OUTPUT_DIR/process.xml"
LOG_PATH="$OUTPUT_DIR/process.log"

# Start the process with Wine, monitor it with strace, and save XML output to file
start_process_with_wine "$EXE_PATH" "$OUTPUT_XML_PATH" "$LOG_PATH"

# Notify user of the XML and log file locations
echo "Process XML saved to: $OUTPUT_XML_PATH"
echo "Process log saved to: $LOG_PATH"
